<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1" />
<title>터치 생존 리그</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Orbitron&display=swap');
  html, body {
    margin: 0; padding: 0; overflow: hidden; touch-action: none;
    background: linear-gradient(135deg, #0f0f0f, #1c1c1c);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    -webkit-user-select: none; -ms-user-select: none; user-select: none;
    height: 100vh;
  }

  #overlay {
    position: fixed; top:0; left:0; width:100vw; height:100vh;
    background: rgba(0,0,0,0.85);
    z-index: 10000;
    display: flex; flex-wrap: wrap;
    justify-content: center; align-content: center;
    gap: 14px;
    padding: 30px;
    box-sizing: border-box;
  }
  #overlay button {
    flex: 1 1 40%;
    max-width: 120px;
    background: #111;
    border: 2px solid #00ffff;
    color: #00ffff;
    font-size: 18px;
    font-weight: 700;
    border-radius: 14px;
    padding: 14px 0;
    cursor: pointer;
    transition: background-color 0.3s, color 0.3s;
  }
  #overlay button:hover:not(:disabled) {
    background-color: #00ffff;
    color: #111;
  }
  #overlay #startBtn {
    flex-basis: 100%;
    max-width: 260px;
    margin-top: 20px;
    font-size: 20px;
    font-weight: 900;
  }
  #overlay #startBtn:disabled {
    border-color: #555;
    color: #555;
    cursor: not-allowed;
  }

  #message {
    position: fixed;
    top: 0; left: 0;
    width: 100vw;
    height: 40px;
    line-height: 40px;
    color: #00ffff;
    font-size: 20px;
    text-align: center;
    font-weight: 700;
    user-select: none;
    pointer-events: none;
    z-index: 9999;
    font-family: 'Orbitron', monospace, sans-serif;
    letter-spacing: 0.06em;
    background: transparent;
    text-shadow:
      0 0 6px #00ffffaa,
      0 0 10px #00ffff88;
  }

  .circle {
    position: absolute;
    width: 100px; height: 100px;
    border-radius: 50%;
    background-color: #222;
    box-shadow: 0 0 14px #00ffffaa inset;
    display: flex;
    align-items: center;
    justify-content: center;
    pointer-events: auto;
    user-select: none;
    font-weight: 900;
    font-size: 48px;
    color: white;
    cursor: grab;
    touch-action: none;
  }
  .circle:active {
    cursor: grabbing;
  }

  .circle .num-outside {
    position: absolute;
    top: 50%;
    left: 110%;
    transform: translateY(-50%);
    font-size: 18px;
    font-weight: 700;
    color: white;
    text-shadow: 0 0 6px #000;
    user-select: none;
    pointer-events: none;
  }

  #leagueBoard {
    position: fixed;
    top: 40px;
    left: 10px;
    max-width: 300px;
    max-height: 90vh;
    overflow-y: auto;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 12px;
    padding: 8px 12px;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: #00ffff;
    box-shadow:
      0 0 10px #00ffffaa;
    user-select: none;
    z-index: 9998;
  }
  #leagueBoard h3 {
    margin: 0 0 10px 0;
    font-weight: 900;
    font-size: 18px;
    text-align: center;
  }
  #leagueBoard ul {
    list-style: none;
    padding: 0; margin: 0;
  }
  #leagueBoard li {
    margin-bottom: 6px;
    font-weight: 700;
    font-size: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  #leagueBoard .color-box {
    width: 18px;
    height: 18px;
    border-radius: 4px;
    border: 1.5px solid #00ffff;
    box-shadow: 0 0 6px #00ffffaa;
  }

</style>
</head>
<body>

<div id="overlay">
  <button data-count="5">5명 이하</button>
  <button data-count="10">10명 이하</button>
  <button data-count="15">15명 이하</button>
  <button data-count="20">20명 이하</button>
  <button data-count="25">25명 이하</button>
  <button id="startBtn" disabled>선택 후 시작</button>
</div>

<div id="message">참가 인원을 선택하세요</div>
<div id="leagueBoard" style="display:none;">
  <h3>당첨자 리그</h3>
  <ul id="winnerList"></ul>
</div>

<script>
  // --- 전역 상태 ---
  let totalPlayers = 0;
  let remainingPlayers = [];
  let finalists = [];
  let round = 0;
  const maxGroup = 5;
  let gameStarted = false;
  let touches = {};
  let idleTimeout = null;

  // --- DOM ---
  const overlay = document.getElementById('overlay');
  const buttons = Array.from(overlay.querySelectorAll('button[data-count]'));
  const startBtn = document.getElementById('startBtn');
  const message = document.getElementById('message');
  const leagueBoard = document.getElementById('leagueBoard');
  const winnerList = document.getElementById('winnerList');

  // --- 상태 변수 ---
  let selectedCount = 0;

  // --- 유틸 ---
  function getRandomColor() {
    const letters = '0123456789ABCDEF';
    let color = '#';
    for(let i=0; i<6; i++) {
      color += letters[Math.floor(Math.random() * 16)];
    }
    return color;
  }
  // 색상 밝기에 따라 글자색 흰/검정 조절
  function getContrastColor(hexColor){
    if (!hexColor) return 'white';
    let c = hexColor.substring(1); // remove #
    let rgb = parseInt(c, 16);
    let r = (rgb >> 16) & 0xff;
    let g = (rgb >> 8) & 0xff;
    let b = rgb & 0xff;
    // https://www.w3.org/TR/AERT/#color-contrast
    let brightness = (r * 299 + g * 587 + b * 114) / 1000;
    return brightness > 125 ? 'black' : 'white';
  }

  // --- 버튼 선택 처리 ---
  buttons.forEach(btn => {
    btn.addEventListener('click', () => {
      buttons.forEach(b => b.style.borderColor = '#00ffff');
      btn.style.borderColor = '#ff00ff';
      selectedCount = parseInt(btn.dataset.count);
      if(selectedCount <= 5){
        startBtn.textContent = '시작';
      } else {
        startBtn.textContent = '리그 시작';
      }
      startBtn.disabled = false;
    });
  });

  // --- 시작 버튼 클릭 ---
  startBtn.addEventListener('click', () => {
    if(selectedCount < 1) return;
    startLeague(selectedCount);
  });

  // --- 메시지 출력 ---
  function updateMessage(text) {
    message.textContent = text;
  }

  // --- 원 생성 ---
  function createCircle(id, x, y, number, color) {
    const c = document.createElement('div');
    c.classList.add('circle');
    c.style.left = (x - 50) + 'px';
    c.style.top = (y - 50) + 'px';
    c.style.backgroundColor = color;
    c.dataset.id = id;
    c.dataset.number = number;

    // 가운데 큰 숫자 (원안)
    c.textContent = number;

    // 바깥쪽 작은 숫자
    const numOutside = document.createElement('div');
    numOutside.classList.add('num-outside');
    numOutside.textContent = number;
    c.appendChild(numOutside);

    // 텍스트 색상 대비 맞추기
    const textColor = getContrastColor(color);
    c.style.color = textColor;
    numOutside.style.color = textColor;

    // 드래그 지원
    c.addEventListener('touchstart', e => {
      e.stopPropagation();
      c.style.cursor = 'grabbing';
    });
    c.addEventListener('touchend', e => {
      e.stopPropagation();
      c.style.cursor = 'grab';
    });
    c.addEventListener('touchmove', e => {
      e.stopPropagation();
      if(gameStarted) return;
      const touch = e.touches[0];
      c.style.left = (touch.clientX - 50) + 'px';
      c.style.top = (touch.clientY - 50) + 'px';
    }, { passive: false });

    document.body.appendChild(c);
    return c;
  }

  // 원 제거
  function removeCircle(id) {
    const el = document.querySelector(`.circle[data-id='${id}']`);
    if(el) el.remove();
  }

  // 원 위치 업데이트
  function updateCirclePosition(id, x, y) {
    const el = document.querySelector(`.circle[data-id='${id}']`);
    if(el) {
      el.style.left = (x - 50) + 'px';
      el.style.top = (y - 50) + 'px';
    }
  }

  // --- 리그보드 갱신 ---
  function updateLeagueBoard() {
    if(finalists.length === 0) {
      leagueBoard.style.display = 'none';
      return;
    }
    leagueBoard.style.display = 'block';
    winnerList.innerHTML = '';
    finalists.forEach((f, idx) => {
      const li = document.createElement('li');
      const colorBox = document.createElement('div');
      colorBox.classList.add('color-box');
      colorBox.style.backgroundColor = f.color;
      li.appendChild(colorBox);

      const text = document.createTextNode(` ${f.number}번`);
      li.appendChild(text);
      li.style.color = getContrastColor(f.color) === 'white' ? '#00ffff' : '#00ffff';
      winnerList.appendChild(li);
    });
  }

  // --- 게임 시작 ---
  function startLeague(count) {
    totalPlayers = count;
    remainingPlayers = Array.from({length: totalPlayers}, (_, i) => i + 1);
    finalists = [];
    round = 1;
    touches = {};
    gameStarted = false;
    overlay.style.display = 'none';
    leagueBoard.style.display = 'none';
    updateMessage(`${round}라운드: 손가락을 올려주세요 (최대 ${maxGroup}명)`);
  }

  // --- 게임 시작후 실제 게임 로직 ---
  function startGame() {
    gameStarted = true;
    updateMessage(`🎮 ${round}라운드 게임 시작! 랜덤 탈락 중...`);
    navigator.vibrate && navigator.vibrate([300, 100, 300]);

    let ids = Object.keys(touches);
    if(ids.length <= 1){
      // 바로 승자 처리
      finishRound(ids[0]);
      return;
    }

    const interval = setInterval(() => {
      if(ids.length <= 1) {
        clearInterval(interval);
        finishRound(ids[0]);
        return;
      }

      const randIdx = Math.floor(Math.random() * ids.length);
      const removedId = ids.splice(randIdx, 1)[0];
      removeCircle(removedId);
      delete touches[removedId];
    }, 1500);
  }

  // --- 라운드 종료 처리 ---
  function finishRound(winnerId) {
    if(!winnerId) {
      updateMessage('⚠️ 터치 부족으로 라운드 종료');
      waitForNextRound();
      return;
    }

    const winner = touches[winnerId];
    if(!winner) {
      updateMessage('⚠️ 오류: 승자 정보 없음');
      waitForNextRound();
      return;
    }

    finalists.push({number: winner.number, color: winner.color});
    updateLeagueBoard();

    updateMessage(`🎯 ${round}라운드 당첨자: ${winner.number}번`, true);

    // 남은 플레이어 다시 채우기
    for(let id in touches) {
      removeCircle(id);
    }
    touches = {};

    // 다음 라운드 준비
    if(round * maxGroup < totalPlayers) {
      // 아직 참가자 남음
      remainingPlayers = remainingPlayers.filter(n => n !== winner.number);
      round++;
      waitForNextRound();
    } else {
      // 결승전 진행 또는 최종 우승자 결정
      if(finalists.length > 1) {
        remainingPlayers = finalists.map(f => f.number);
        finalists = [];
        round = '🔥 결승전';
        waitForNextRound();
      } else {
        // 최종 우승자 출력 후 리셋 대기
        updateMessage(`🏆 최종 우승자: ${winner.number}번 🎉 터치하면 초기화`, true);
        leagueBoard.style.display = 'block';
        waitForReset();
      }
    }
  }

  // --- 다음 라운드 또는 결승 시작 대기 ---
  function waitForNextRound() {
    updateMessage(prev => prev + ' 👉 화면 터치로 다음 진행');
    function onNextTouch() {
      window.removeEventListener('touchstart', onNextTouch);
      if(typeof round === 'string' && round.includes('🔥')) {
        // 결승전 시작
        startLeagueRound();
      } else {
        startLeagueRound();
      }
    }
    window.addEventListener('touchstart', onNextTouch, { once: true });
  }

  // --- 완전 초기화 대기 ---
  function waitForReset() {
    function onResetTouch() {
      window.removeEventListener('touchstart', onResetTouch);
      resetGame();
    }
    window.addEventListener('touchstart', onResetTouch, { once: true });
  }

  // --- 라운드 게임 시작 ---
  function startLeagueRound() {
    if(typeof round === 'string' && round.includes('🔥')) {
      updateMessage(`${round}: 손가락을 올려주세요 (최대 ${maxGroup}명)`);
    } else {
      updateMessage(`${round}라운드: 손가락을 올려주세요 (최대 ${maxGroup}명)`);
    }
    gameStarted = false;
    touches = {};
  }

  // --- 게임 초기화 ---
  function resetGame() {
    totalPlayers = 0;
    remainingPlayers = [];
    finalists = [];
    round = 0;
    touches = {};
    gameStarted = false;
    overlay.style.display = 'flex';
    winnerList.innerHTML = '';
    leagueBoard.style.display = 'none';
    updateMessage('참가 인원을 선택하세요');
    startBtn.disabled = true;
    buttons.forEach(b => b.style.borderColor = '#00ffff');
    selectedCount = 0;
  }

  // --- 터치 이벤트 처리 ---
  window.addEventListener('touchstart', e => {
    if(!gameStarted) {
      // 시작 전은 무시 (오버레이가 있으니)
      if(overlay.style.display !== 'none') return;
      updateMessage('');
      for(const t of e.changedTouches){
        if(Object.keys(touches).length >= maxGroup) break;
        // 새 터치 생성
        const id = 't'+t.identifier;
        if(touches[id]) continue;

        const number = remainingPlayers.shift();
        if(!number) break;

        const color = getRandomColor();
        const circle = createCircle(id, t.clientX, t.clientY, number, color);

        touches[id] = {id, number, color, circle};
      }
      if(Object.keys(touches).length === maxGroup) {
        startGame();
      }
    }
  }, { passive: false });

  window.addEventListener('touchmove', e => {
    e.preventDefault();
    if(!gameStarted) return;
    for(const t of e.changedTouches){
      const id = 't'+t.identifier;
      if(!touches[id]) continue;
      const circle = touches[id].circle;
      circle.style.left = (t.clientX - 50) + 'px';
      circle.style.top = (t.clientY - 50) + 'px';
    }
  }, { passive: false });

  window.addEventListener('touchend', e => {
    if(!gameStarted) return;
    for(const t of e.changedTouches){
      const id = 't'+t.identifier;
      if(!touches[id]) continue;
      removeCircle(id);
      delete touches[id];
    }
    if(Object.keys(touches).length <= 1) {
      finishRound(Object.keys(touches)[0]);
    }
  });

  // --- 초기 상태 ---
  resetGame();

</script>

</body>
</html>
