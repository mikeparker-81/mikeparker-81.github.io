<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1" />
  <title>í„°ì¹˜ ìƒì¡´ ë¦¬ê·¸</title>
  <style>
    html, body {
      margin: 0; padding: 0; overflow: hidden; touch-action: none;
      background: linear-gradient(135deg, #0f0f0f, #1c1c1c);
      font-family: 'Segoe UI', sans-serif;
      -webkit-user-select: none; -ms-user-select: none; user-select: none;
      color: white;
      height: 100vh;
    }

    #config {
      position: absolute;
      top: 40px; left: 50%;
      transform: translateX(-50%);
      color: white;
      font-size: 20px;
      text-align: center;
      z-index: 9999;
      background-color: rgba(0, 0, 0, 0.6);
      padding: 12px 20px;
      border-radius: 12px;
      box-shadow: 0 0 15px #00ffff55;
    }

    #config select, #config button {
      margin: 10px;
      padding: 6px 10px;
      font-size: 16px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
    }

    .circle {
      position: absolute;
      width: 100px; height: 100px;
      border-radius: 50%;
      transform: scale(1);
      animation: pulse 1s infinite;
      pointer-events: none;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 26px;
      font-weight: bold;
      color: white;
      box-shadow: 0 0 10px rgba(255,255,255,0.5);
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.3); }
      100% { transform: scale(1); }
    }

    #message {
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      color: #00ffff;
      font-size: 24px;
      background-color: rgba(0, 0, 0, 0.6);
      padding: 10px 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px #00ffff55;
      z-index: 9999;
      white-space: pre-line;
      user-select: none;
      cursor: default;
    }

    #scoreboard {
      position: absolute;
      top: 10px;
      left: 10px;
      max-height: 90vh;
      overflow-y: auto;
      background: rgba(0,0,0,0.7);
      padding: 10px;
      border-radius: 10px;
      font-size: 16px;
      color: white;
      z-index: 9999;
      min-width: 220px;
      user-select: none;
    }

    #scoreboard table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 6px;
    }
    #scoreboard th, #scoreboard td {
      border: 1px solid #00ffff66;
      padding: 4px 6px;
      text-align: center;
    }
    #scoreboard th {
      background-color: #00ffff33;
    }

  </style>
</head>
<body>
  <div id="config">
    <label for="playerCount">ì°¸ê°€ ì¸ì›:</label>
    <select id="playerCount">
      <option value="5">5ëª…</option>
      <option value="10">10ëª…</option>
      <option value="15">15ëª…</option>
      <option value="20">20ëª…</option>
      <option value="25">25ëª…</option>
    </select>
    <button onclick="startLeague()">ë¦¬ê·¸ ì‹œì‘</button>
  </div>

  <div id="scoreboard" style="display:none;">
    <div><strong>ë¼ìš´ë“œë³„ ë‹¹ì²¨ì</strong></div>
    <div id="winnersList" style="margin-bottom:12px;"></div>
    <div><strong>ì¤‘ë„ íƒˆë½ì</strong></div>
    <table>
      <thead><tr><th>ë²ˆí˜¸</th><th>íƒˆë½ ë¼ìš´ë“œ</th></tr></thead>
      <tbody id="losersTable"></tbody>
    </table>
  </div>

  <div id="message">ì°¸ê°€ ì¸ì›ì„ ì„ íƒí•˜ê³  ì‹œì‘í•˜ì„¸ìš”</div>

  <script>
    const touches = {};
    let gameStarted = false;
    let checkIdleTimeout = null;
    let totalPlayers = 0;
    let remainingPlayers = [];
    let finalists = [];
    let losers = []; // ì¤‘ë„ íƒˆë½ì ê¸°ë¡
    let round = 1;
    const maxGroup = 5;

    // ë‹¹ì²¨ì ëˆ„ì  ê¸°ë¡ (ë¼ìš´ë“œë³„)
    let winnersByRound = [];

    function getRandomColor() {
      const letters = '0123456789ABCDEF';
      let color = '#';
      for (let i = 0; i < 6; i++) color += letters[Math.floor(Math.random() * 16)];
      return color;
    }

    function createCircle(id, x, y, number, color) {
      const circle = document.createElement('div');
      circle.classList.add('circle');
      circle.style.left = `${x - 50}px`;
      circle.style.top = `${y - 50}px`;
      circle.style.backgroundColor = color;
      circle.dataset.id = id;
      circle.textContent = number;
      document.body.appendChild(circle);
      return circle;
    }

    function removeCircle(id) {
      const el = document.querySelector(`.circle[data-id='${id}']`);
      if (el) el.remove();
    }

    function updateCirclePosition(id, x, y) {
      const el = document.querySelector(`.circle[data-id='${id}']`);
      if (el) {
        el.style.left = `${x - 50}px`;
        el.style.top = `${y - 50}px`;
      }
    }

    function updateMessage(msg, visible = true, cursorPointer = false) {
      const el = document.getElementById('message');
      el.textContent = msg;
      el.style.display = visible ? 'block' : 'none';
      el.style.cursor = cursorPointer ? 'pointer' : 'default';
    }

    function updateWinnersDisplay() {
      const container = document.getElementById('winnersList');
      container.innerHTML = ''; // ì´ˆê¸°í™”

      winnersByRound.forEach((winner, idx) => {
        const roundText = (typeof winner.round === 'number') ? `${winner.round}ë¼ìš´ë“œ` : winner.round;
        const span = document.createElement('div');
        span.style.marginBottom = '4px';
        span.innerHTML = `<strong>${roundText}:</strong> ` +
          `<span style="color:${winner.color}; font-weight:bold;">${winner.number}ë²ˆ</span>`;
        container.appendChild(span);
      });
    }

    function updateLosersTable() {
      const tbody = document.getElementById('losersTable');
      tbody.innerHTML = '';
      losers.forEach(loser => {
        const tr = document.createElement('tr');
        const tdNum = document.createElement('td');
        tdNum.textContent = loser.number;
        const tdRound = document.createElement('td');
        tdRound.textContent = loser.round;
        tr.appendChild(tdNum);
        tr.appendChild(tdRound);
        tbody.appendChild(tr);
      });
    }

    function startLeague() {
      totalPlayers = parseInt(document.getElementById('playerCount').value);
      remainingPlayers = Array.from({ length: totalPlayers }, (_, i) => i + 1);
      finalists = [];
      losers = [];
      winnersByRound = [];
      round = 1;
      gameStarted = false;

      document.getElementById('config').style.display = 'none';
      document.getElementById('scoreboard').style.display = 'block';
      updateWinnersDisplay();
      updateLosersTable();
      updateMessage(`${round}ë¼ìš´ë“œ: ì†ê°€ë½ì„ ì˜¬ë ¤ì£¼ì„¸ìš” (ìµœëŒ€ ${maxGroup}ëª…)`, true);
    }

    function startGame() {
      gameStarted = true;
      updateMessage(`ğŸ® ê²Œì„ ì‹œì‘! ${round}ë¼ìš´ë“œ ëœë¤ íƒˆë½ ì¤‘...`, true);
      navigator.vibrate && navigator.vibrate([300, 100, 300]);

      const ids = Object.keys(touches);

      if(ids.length < 2) {
        // í„°ì¹˜ê°€ 1ëª… ì´í•˜ë©´ ë¬´ì¡°ê±´ ê·¸ ì‚¬ëŒì´ ë‹¹ì²¨
        const winnerId = ids[0];
        const winner = touches[winnerId];
        endRound(winner);
        return;
      }

      const interval = setInterval(() => {
        if (ids.length <= 1) {
          clearInterval(interval);
          const winnerId = ids[0];
          const winner = touches[winnerId];
          endRound(winner);
          return;
        }

        const randomIndex = Math.floor(Math.random() * ids.length);
        const removedId = ids.splice(randomIndex, 1)[0];
        const removedPlayer = touches[removedId];
        if(removedPlayer) {
          // ì¤‘ë„ íƒˆë½ìë¡œ ê¸°ë¡
          losers.push({ number: removedPlayer.number, round });
          updateLosersTable();
        }
        removeCircle(removedId);
      }, 1500);
    }

    // ë¼ìš´ë“œ ì¢…ë£Œ ì²˜ë¦¬
    function endRound(winner) {
      updateMessage(`ğŸ¯ ${winner.number}ë²ˆ ë‹¹ì²¨! í„°ì¹˜í•˜ë©´ ë‹¤ìŒ ì§„í–‰`, true, true);

      winnersByRound.push({ round, number: winner.number, color: winner.color });
      updateWinnersDisplay();

      finalists.push({ number: winner.number, color: winner.color });
      gameStarted = false;

      Object.keys(touches).forEach(removeCircle);
      for (let id in touches) delete touches[id];

      // ë‹¤ìŒ ì§„í–‰ í„°ì¹˜ ì´ë²¤íŠ¸ í™œì„±í™”
      const msgEl = document.getElementById('message');
      const onNext = () => {
        msgEl.style.cursor = 'default';
        msgEl.removeEventListener('click', onNext);

        if (round === 'ğŸ”¥ ê²°ìŠ¹ì „') {
          // ìµœì¢… ìš°ìŠ¹ì í‘œì‹œ í›„ ì´ˆê¸°í™” ëŒ€ê¸°
          updateMessage(`ğŸ† ìµœì¢… ìš°ìŠ¹ì: ${winner.number}ë²ˆ! í„°ì¹˜í•˜ë©´ ë‹¤ì‹œ ì‹œì‘í•©ë‹ˆë‹¤`, true, true);

          msgEl.addEventListener('click', () => {
            resetGame();
          }, { once: true });
          return;
        }

        // ë‹¤ìŒ ë¼ìš´ë“œ ì¤€ë¹„
        if(remainingPlayers.length === 0 && finalists.length > 1){
          // ê²°ìŠ¹ ì§„ì…
          remainingPlayers = finalists.map(f => f.number);
          finalists = [];
          round = 'ğŸ”¥ ê²°ìŠ¹ì „';
          updateMessage(`${round}: ì†ê°€ë½ì„ ì˜¬ë ¤ì£¼ì„¸ìš” (ìµœëŒ€ ${maxGroup}ëª…)`, true);
        } else if(remainingPlayers.length > 0){
          round++;
          updateMessage(`${round}ë¼ìš´ë“œ: ì†ê°€ë½ì„ ì˜¬ë ¤ì£¼ì„¸ìš” (ìµœëŒ€ ${maxGroup}ëª…)`, true);
        } else {
          // ë§Œì•½ ì—¬ê¸° ì˜¨ë‹¤ë©´ ê²Œì„ ëë‚œ ê±°ì„. ì•ˆì „ì¥ì¹˜
          updateMessage(`ğŸ† ìµœì¢… ìš°ìŠ¹ì: ${winner.number}ë²ˆ! í„°ì¹˜í•˜ë©´ ë‹¤ì‹œ ì‹œì‘í•©ë‹ˆë‹¤`, true, true);
          msgEl.addEventListener('click', () => resetGame(), { once: true });
          return;
        }

        gameStarted = false;
      };

      msgEl.addEventListener('click', onNext, { once: true });
    }

    function resetGame() {
      document.getElementById('config').style.display = 'block';
      document.getElementById('scoreboard').style.display = 'none';
      updateMessage('ì°¸ê°€ ì¸ì›ì„ ì„ íƒí•˜ê³  ì‹œì‘í•˜ì„¸ìš”');
      for (let id in touches) removeCircle(id);
      for (let id in touches) delete touches[id];
      gameStarted = false;
      totalPlayers = 0;
      remainingPlayers = [];
      finalists = [];
      losers = [];
      winnersByRound = [];
      round = 1;
    }

    function checkIfIdle() {
      if (Object.keys(touches).length >= 2) {
        if (checkIdleTimeout) clearTimeout(checkIdleTimeout);
        checkIdleTimeout = setTimeout(() => {
          if (!gameStarted) {
            startGame();
          }
        }, 3000);
      }
    }

    window.addEventListener('touchstart', (e) => {
      if (gameStarted) return;
      updateMessage('', false); // í„°ì¹˜í•˜ë©´ ë©”ì‹œì§€ ìˆ¨ê¹€
      for (const t of e.changedTouches) {
        if (Object.keys(touches).length >= maxGroup) return;
        if (!touches[t.identifier]) {
          const number = remainingPlayers.shift();
          if (!number) return;
          const color = getRandomColor();
          const circle = createCircle(t.identifier, t.clientX, t.clientY, number, color);
          touches[t.identifier] = { el: circle, number, color };
        }
      }
      checkIfIdle();
    });

    window.addEventListener('touchmove', (e) => {
      if (gameStarted) return;
      for (const t of e.changedTouches) {
        if (touches[t.identifier]) updateCirclePosition(t.identifier, t.clientX, t.clientY);
      }
    });

    window.addEventListener('touchend', (e) => {
      if (gameStarted) return;
      for (const t of e.changedTouches) {
        if (touches[t.identifier]) {
          removeCircle(t.identifier);
          remainingPlayers.unshift(touches[t.identifier].number);
          delete touches[t.identifier];
        }
      }
      updateMessage(`${round}ë¼ìš´ë“œ: ì†ê°€ë½ì„ ì˜¬ë ¤ì£¼ì„¸ìš” (ìµœëŒ€ ${maxGroup}ëª…)`);
    });

    // í„°ì¹˜ ì œìŠ¤ì²˜ ë°©ì§€
    document.addEventListener('gesturestart', e => e.preventDefault());
    document.addEventListener('gesturechange', e => e.preventDefault());
    document.addEventListener('gestureend', e => e.preventDefault());
    document.addEventListener('touchmove', e => e.preventDefault(), { passive: false });
  </script>
</body>
</html>
