<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1" />
<title>í„°ì¹˜ ìƒì¡´ ë¦¬ê·¸</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Orbitron&display=swap');
  html, body {
    margin: 0; padding: 0; overflow: hidden; touch-action: none;
    background: linear-gradient(135deg, #0f0f0f, #1c1c1c);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    -webkit-user-select: none; -ms-user-select: none; user-select: none;
    height: 100vh;
  }

  #overlay {
    position: fixed; top:0; left:0; width:100vw; height:100vh;
    background: rgba(0,0,0,0.85);
    z-index: 10000;
    display: flex; flex-wrap: wrap;
    justify-content: center; align-content: center;
    gap: 14px;
    padding: 30px;
    box-sizing: border-box;
  }
  #overlay button {
    flex: 1 1 40%;
    max-width: 120px;
    background: #111;
    border: 2px solid #00ffff;
    color: #00ffff;
    font-size: 18px;
    font-weight: 700;
    border-radius: 14px;
    padding: 14px 0;
    cursor: pointer;
    transition: background-color 0.3s, color 0.3s;
  }
  #overlay button:hover:not(:disabled) {
    background-color: #00ffff;
    color: #111;
  }
  #overlay #startBtn {
    flex-basis: 100%;
    max-width: 260px;
    margin-top: 20px;
    font-size: 20px;
    font-weight: 900;
  }
  #overlay #startBtn:disabled {
    border-color: #555;
    color: #555;
    cursor: not-allowed;
  }

  #message {
    position: fixed;
    top: 0; left: 0;
    width: 100vw;
    height: 40px;
    line-height: 40px;
    color: #00ffff;
    font-size: 20px;
    text-align: center;
    font-weight: 700;
    user-select: none;
    pointer-events: none;
    z-index: 9999;
    font-family: 'Orbitron', monospace, sans-serif;
    letter-spacing: 0.06em;
    background: transparent;
    text-shadow:
      0 0 6px #00ffffaa,
      0 0 10px #00ffff88;
  }

  .circle {
    position: absolute;
    width: 100px; height: 100px;
    border-radius: 50%;
    background-color: #222;
    box-shadow: 0 0 14px #00ffffaa inset;
    display: flex;
    align-items: center;
    justify-content: center;
    pointer-events: auto;
    user-select: none;
    font-weight: 900;
    font-size: 48px;
    color: white;
    cursor: grab;
    touch-action: none;
  }
  .circle:active {
    cursor: grabbing;
  }

  .circle .num-outside {
    position: absolute;
    top: 50%;
    left: 110%;
    transform: translateY(-50%);
    font-size: 18px;
    font-weight: 700;
    color: white;
    text-shadow: 0 0 6px #000;
    user-select: none;
    pointer-events: none;
  }

  #leagueBoard {
    position: fixed;
    top: 40px;
    left: 10px;
    max-width: 300px;
    max-height: 90vh;
    overflow-y: auto;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 12px;
    padding: 8px 12px;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: #00ffff;
    box-shadow:
      0 0 10px #00ffffaa;
    user-select: none;
    z-index: 9998;
  }
  #leagueBoard h3 {
    margin: 0 0 10px 0;
    font-weight: 900;
    font-size: 18px;
    text-align: center;
  }
  #leagueBoard ul {
    list-style: none;
    padding: 0; margin: 0;
  }
  #leagueBoard li {
    margin-bottom: 6px;
    font-weight: 700;
    font-size: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  #leagueBoard .color-box {
    width: 18px;
    height: 18px;
    border-radius: 4px;
    border: 1.5px solid #00ffff;
    box-shadow: 0 0 6px #00ffffaa;
  }

</style>
</head>
<body>

<div id="overlay">
  <button data-count="5">5ëª… ì´í•˜</button>
  <button data-count="10">10ëª… ì´í•˜</button>
  <button data-count="15">15ëª… ì´í•˜</button>
  <button data-count="20">20ëª… ì´í•˜</button>
  <button data-count="25">25ëª… ì´í•˜</button>
  <button id="startBtn" disabled>ì„ íƒ í›„ ì‹œì‘</button>
</div>

<div id="message">ì°¸ê°€ ì¸ì›ì„ ì„ íƒí•˜ì„¸ìš”</div>
<div id="leagueBoard" style="display:none;">
  <h3>ë‹¹ì²¨ì ë¦¬ê·¸</h3>
  <ul id="winnerList"></ul>
</div>

<script>
  // --- ì „ì—­ ìƒíƒœ ---
  let totalPlayers = 0;
  let remainingPlayers = [];
  let finalists = [];
  let round = 0;
  const maxGroup = 5;
  let gameStarted = false;
  let touches = {};
  let idleTimeout = null;

  // --- DOM ---
  const overlay = document.getElementById('overlay');
  const buttons = Array.from(overlay.querySelectorAll('button[data-count]'));
  const startBtn = document.getElementById('startBtn');
  const message = document.getElementById('message');
  const leagueBoard = document.getElementById('leagueBoard');
  const winnerList = document.getElementById('winnerList');

  // --- ìƒíƒœ ë³€ìˆ˜ ---
  let selectedCount = 0;

  // --- ìœ í‹¸ ---
  function getRandomColor() {
    const letters = '0123456789ABCDEF';
    let color = '#';
    for(let i=0; i<6; i++) {
      color += letters[Math.floor(Math.random() * 16)];
    }
    return color;
  }
  // ìƒ‰ìƒ ë°ê¸°ì— ë”°ë¼ ê¸€ììƒ‰ í°/ê²€ì • ì¡°ì ˆ
  function getContrastColor(hexColor){
    if (!hexColor) return 'white';
    let c = hexColor.substring(1); // remove #
    let rgb = parseInt(c, 16);
    let r = (rgb >> 16) & 0xff;
    let g = (rgb >> 8) & 0xff;
    let b = rgb & 0xff;
    // https://www.w3.org/TR/AERT/#color-contrast
    let brightness = (r * 299 + g * 587 + b * 114) / 1000;
    return brightness > 125 ? 'black' : 'white';
  }

  // --- ë²„íŠ¼ ì„ íƒ ì²˜ë¦¬ ---
  buttons.forEach(btn => {
    btn.addEventListener('click', () => {
      buttons.forEach(b => b.style.borderColor = '#00ffff');
      btn.style.borderColor = '#ff00ff';
      selectedCount = parseInt(btn.dataset.count);
      if(selectedCount <= 5){
        startBtn.textContent = 'ì‹œì‘';
      } else {
        startBtn.textContent = 'ë¦¬ê·¸ ì‹œì‘';
      }
      startBtn.disabled = false;
    });
  });

  // --- ì‹œì‘ ë²„íŠ¼ í´ë¦­ ---
  startBtn.addEventListener('click', () => {
    if(selectedCount < 1) return;
    startLeague(selectedCount);
  });

  // --- ë©”ì‹œì§€ ì¶œë ¥ ---
  function updateMessage(text) {
    message.textContent = text;
  }

  // --- ì› ìƒì„± ---
  function createCircle(id, x, y, number, color) {
    const c = document.createElement('div');
    c.classList.add('circle');
    c.style.left = (x - 50) + 'px';
    c.style.top = (y - 50) + 'px';
    c.style.backgroundColor = color;
    c.dataset.id = id;
    c.dataset.number = number;

    // ê°€ìš´ë° í° ìˆ«ì (ì›ì•ˆ)
    c.textContent = number;

    // ë°”ê¹¥ìª½ ì‘ì€ ìˆ«ì
    const numOutside = document.createElement('div');
    numOutside.classList.add('num-outside');
    numOutside.textContent = number;
    c.appendChild(numOutside);

    // í…ìŠ¤íŠ¸ ìƒ‰ìƒ ëŒ€ë¹„ ë§ì¶”ê¸°
    const textColor = getContrastColor(color);
    c.style.color = textColor;
    numOutside.style.color = textColor;

    // ë“œë˜ê·¸ ì§€ì›
    c.addEventListener('touchstart', e => {
      e.stopPropagation();
      c.style.cursor = 'grabbing';
    });
    c.addEventListener('touchend', e => {
      e.stopPropagation();
      c.style.cursor = 'grab';
    });
    c.addEventListener('touchmove', e => {
      e.stopPropagation();
      if(gameStarted) return;
      const touch = e.touches[0];
      c.style.left = (touch.clientX - 50) + 'px';
      c.style.top = (touch.clientY - 50) + 'px';
    }, { passive: false });

    document.body.appendChild(c);
    return c;
  }

  // ì› ì œê±°
  function removeCircle(id) {
    const el = document.querySelector(`.circle[data-id='${id}']`);
    if(el) el.remove();
  }

  // ì› ìœ„ì¹˜ ì—…ë°ì´íŠ¸
  function updateCirclePosition(id, x, y) {
    const el = document.querySelector(`.circle[data-id='${id}']`);
    if(el) {
      el.style.left = (x - 50) + 'px';
      el.style.top = (y - 50) + 'px';
    }
  }

  // --- ë¦¬ê·¸ë³´ë“œ ê°±ì‹  ---
  function updateLeagueBoard() {
    if(finalists.length === 0) {
      leagueBoard.style.display = 'none';
      return;
    }
    leagueBoard.style.display = 'block';
    winnerList.innerHTML = '';
    finalists.forEach((f, idx) => {
      const li = document.createElement('li');
      const colorBox = document.createElement('div');
      colorBox.classList.add('color-box');
      colorBox.style.backgroundColor = f.color;
      li.appendChild(colorBox);

      const text = document.createTextNode(` ${f.number}ë²ˆ`);
      li.appendChild(text);
      li.style.color = getContrastColor(f.color) === 'white' ? '#00ffff' : '#00ffff';
      winnerList.appendChild(li);
    });
  }

  // --- ê²Œì„ ì‹œì‘ ---
  function startLeague(count) {
    totalPlayers = count;
    remainingPlayers = Array.from({length: totalPlayers}, (_, i) => i + 1);
    finalists = [];
    round = 1;
    touches = {};
    gameStarted = false;
    overlay.style.display = 'none';
    leagueBoard.style.display = 'none';
    updateMessage(`${round}ë¼ìš´ë“œ: ì†ê°€ë½ì„ ì˜¬ë ¤ì£¼ì„¸ìš” (ìµœëŒ€ ${maxGroup}ëª…)`);
  }

  // --- ê²Œì„ ì‹œì‘í›„ ì‹¤ì œ ê²Œì„ ë¡œì§ ---
  function startGame() {
    gameStarted = true;
    updateMessage(`ğŸ® ${round}ë¼ìš´ë“œ ê²Œì„ ì‹œì‘! ëœë¤ íƒˆë½ ì¤‘...`);
    navigator.vibrate && navigator.vibrate([300, 100, 300]);

    let ids = Object.keys(touches);
    if(ids.length <= 1){
      // ë°”ë¡œ ìŠ¹ì ì²˜ë¦¬
      finishRound(ids[0]);
      return;
    }

    const interval = setInterval(() => {
      if(ids.length <= 1) {
        clearInterval(interval);
        finishRound(ids[0]);
        return;
      }

      const randIdx = Math.floor(Math.random() * ids.length);
      const removedId = ids.splice(randIdx, 1)[0];
      removeCircle(removedId);
      delete touches[removedId];
    }, 1500);
  }

  // --- ë¼ìš´ë“œ ì¢…ë£Œ ì²˜ë¦¬ ---
  function finishRound(winnerId) {
    if(!winnerId) {
      updateMessage('âš ï¸ í„°ì¹˜ ë¶€ì¡±ìœ¼ë¡œ ë¼ìš´ë“œ ì¢…ë£Œ');
      waitForNextRound();
      return;
    }

    const winner = touches[winnerId];
    if(!winner) {
      updateMessage('âš ï¸ ì˜¤ë¥˜: ìŠ¹ì ì •ë³´ ì—†ìŒ');
      waitForNextRound();
      return;
    }

    finalists.push({number: winner.number, color: winner.color});
    updateLeagueBoard();

    updateMessage(`ğŸ¯ ${round}ë¼ìš´ë“œ ë‹¹ì²¨ì: ${winner.number}ë²ˆ`, true);

    // ë‚¨ì€ í”Œë ˆì´ì–´ ë‹¤ì‹œ ì±„ìš°ê¸°
    for(let id in touches) {
      removeCircle(id);
    }
    touches = {};

    // ë‹¤ìŒ ë¼ìš´ë“œ ì¤€ë¹„
    if(round * maxGroup < totalPlayers) {
      // ì•„ì§ ì°¸ê°€ì ë‚¨ìŒ
      remainingPlayers = remainingPlayers.filter(n => n !== winner.number);
      round++;
      waitForNextRound();
    } else {
      // ê²°ìŠ¹ì „ ì§„í–‰ ë˜ëŠ” ìµœì¢… ìš°ìŠ¹ì ê²°ì •
      if(finalists.length > 1) {
        remainingPlayers = finalists.map(f => f.number);
        finalists = [];
        round = 'ğŸ”¥ ê²°ìŠ¹ì „';
        waitForNextRound();
      } else {
        // ìµœì¢… ìš°ìŠ¹ì ì¶œë ¥ í›„ ë¦¬ì…‹ ëŒ€ê¸°
        updateMessage(`ğŸ† ìµœì¢… ìš°ìŠ¹ì: ${winner.number}ë²ˆ ğŸ‰ í„°ì¹˜í•˜ë©´ ì´ˆê¸°í™”`, true);
        leagueBoard.style.display = 'block';
        waitForReset();
      }
    }
  }

  // --- ë‹¤ìŒ ë¼ìš´ë“œ ë˜ëŠ” ê²°ìŠ¹ ì‹œì‘ ëŒ€ê¸° ---
  function waitForNextRound() {
    updateMessage(prev => prev + ' ğŸ‘‰ í™”ë©´ í„°ì¹˜ë¡œ ë‹¤ìŒ ì§„í–‰');
    function onNextTouch() {
      window.removeEventListener('touchstart', onNextTouch);
      if(typeof round === 'string' && round.includes('ğŸ”¥')) {
        // ê²°ìŠ¹ì „ ì‹œì‘
        startLeagueRound();
      } else {
        startLeagueRound();
      }
    }
    window.addEventListener('touchstart', onNextTouch, { once: true });
  }

  // --- ì™„ì „ ì´ˆê¸°í™” ëŒ€ê¸° ---
  function waitForReset() {
    function onResetTouch() {
      window.removeEventListener('touchstart', onResetTouch);
      resetGame();
    }
    window.addEventListener('touchstart', onResetTouch, { once: true });
  }

  // --- ë¼ìš´ë“œ ê²Œì„ ì‹œì‘ ---
  function startLeagueRound() {
    if(typeof round === 'string' && round.includes('ğŸ”¥')) {
      updateMessage(`${round}: ì†ê°€ë½ì„ ì˜¬ë ¤ì£¼ì„¸ìš” (ìµœëŒ€ ${maxGroup}ëª…)`);
    } else {
      updateMessage(`${round}ë¼ìš´ë“œ: ì†ê°€ë½ì„ ì˜¬ë ¤ì£¼ì„¸ìš” (ìµœëŒ€ ${maxGroup}ëª…)`);
    }
    gameStarted = false;
    touches = {};
  }

  // --- ê²Œì„ ì´ˆê¸°í™” ---
  function resetGame() {
    totalPlayers = 0;
    remainingPlayers = [];
    finalists = [];
    round = 0;
    touches = {};
    gameStarted = false;
    overlay.style.display = 'flex';
    winnerList.innerHTML = '';
    leagueBoard.style.display = 'none';
    updateMessage('ì°¸ê°€ ì¸ì›ì„ ì„ íƒí•˜ì„¸ìš”');
    startBtn.disabled = true;
    buttons.forEach(b => b.style.borderColor = '#00ffff');
    selectedCount = 0;
  }

  // --- í„°ì¹˜ ì´ë²¤íŠ¸ ì²˜ë¦¬ ---
  window.addEventListener('touchstart', e => {
    if(!gameStarted) {
      // ì‹œì‘ ì „ì€ ë¬´ì‹œ (ì˜¤ë²„ë ˆì´ê°€ ìˆìœ¼ë‹ˆ)
      if(overlay.style.display !== 'none') return;
      updateMessage('');
      for(const t of e.changedTouches){
        if(Object.keys(touches).length >= maxGroup) break;
        // ìƒˆ í„°ì¹˜ ìƒì„±
        const id = 't'+t.identifier;
        if(touches[id]) continue;

        const number = remainingPlayers.shift();
        if(!number) break;

        const color = getRandomColor();
        const circle = createCircle(id, t.clientX, t.clientY, number, color);

        touches[id] = {id, number, color, circle};
      }
      if(Object.keys(touches).length === maxGroup) {
        startGame();
      }
    }
  }, { passive: false });

  window.addEventListener('touchmove', e => {
    e.preventDefault();
    if(!gameStarted) return;
    for(const t of e.changedTouches){
      const id = 't'+t.identifier;
      if(!touches[id]) continue;
      const circle = touches[id].circle;
      circle.style.left = (t.clientX - 50) + 'px';
      circle.style.top = (t.clientY - 50) + 'px';
    }
  }, { passive: false });

  window.addEventListener('touchend', e => {
    if(!gameStarted) return;
    for(const t of e.changedTouches){
      const id = 't'+t.identifier;
      if(!touches[id]) continue;
      removeCircle(id);
      delete touches[id];
    }
    if(Object.keys(touches).length <= 1) {
      finishRound(Object.keys(touches)[0]);
    }
  });

  // --- ì´ˆê¸° ìƒíƒœ ---
  resetGame();

</script>

</body>
</html>
