<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1" />
<title>í„°ì¹˜ ìƒì¡´ ë¦¬ê·¸</title>
<style>
  html, body {
    margin: 0; padding: 0; height: 100%; 
    overflow: hidden;
    background: linear-gradient(135deg, #0f0f0f, #1c1c1c);
    font-family: 'Segoe UI', sans-serif;
    -webkit-user-select: none;
    -ms-user-select: none;
    user-select: none;
    touch-action: none;
    color: white;
    position: relative;
  }

  /* ì°¸ê°€ì ì„ íƒ ì „ì²´ ë®ê°œ */
  #overlay {
    position: fixed;
    top:0; left:0; right:0; bottom:0;
    background: rgba(0,0,0,0.9);
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    align-content: center;
    gap: 20px;
    z-index: 99999;
    user-select: none;
  }

  #overlay.hidden {
    display: none;
  }

  .btn-select {
    width: 140px;
    height: 60px;
    font-size: 20px;
    border-radius: 12px;
    border: none;
    background: #0ff;
    color: #000;
    font-weight: bold;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.3s ease;
  }
  .btn-select:hover {
    background: #0cc;
  }

  /* í•˜ë‹¨ ë©”ì‹œì§€ ëŒ€ì‹  ìƒë‹¨ ë©”ì‹œì§€ */
  #message {
    position: fixed;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 26px;
    font-weight: 700;
    pointer-events: none;
    text-shadow: 0 0 8px #00ffffaa;
    white-space: pre-line;
    z-index: 9999;
    user-select: none;
  }

  /* ë‹¹ì²¨ì ëˆ„ì  í‘œì‹œ - ì¢Œìƒë‹¨ */
  #winnersList {
    position: fixed;
    top: 10px;
    left: 10px;
    max-height: 90vh;
    overflow-y: auto;
    padding: 10px 15px;
    border-radius: 10px;
    background: rgba(0,0,0,0.6);
    box-shadow: 0 0 10px #00ffff55;
    font-size: 18px;
    line-height: 1.3;
    z-index: 9999;
    user-select: none;
  }
  #winnersList > div {
    margin-bottom: 6px;
  }

  .circle {
    position: absolute;
    width: 100px;
    height: 100px;
    border-radius: 50%;
    transform: scale(1);
    animation: pulse 1s infinite;
    pointer-events: none;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 26px;
    font-weight: bold;
    color: white;
    box-shadow: 0 0 10px rgba(255,255,255,0.5);
  }

  @keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.3); }
    100% { transform: scale(1); }
  }
</style>
</head>
<body>

<div id="overlay" aria-label="ì°¸ê°€ ì¸ì› ì„ íƒ">
  <!-- ë²„íŠ¼ë“¤ ìë°”ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ë„£ì„ê±°ì„ -->
</div>

<div id="winnersList" aria-live="polite" aria-atomic="true" role="region"></div>
<div id="message" aria-live="assertive" aria-atomic="true"></div>

<script>
(() => {
  // ìƒíƒœ ë³€ìˆ˜
  let gameStarted = false;
  let checkIdleTimeout = null;
  let totalPlayers = 0;
  let remainingPlayers = [];
  let finalists = [];
  let round = 1;
  const maxGroup = 5;
  const touches = {};
  let currentTouchIds = new Set();

  // DOM ìš”ì†Œë“¤
  const overlay = document.getElementById('overlay');
  const messageEl = document.getElementById('message');
  const winnersListEl = document.getElementById('winnersList');

  // ì°¸ê°€ì ì„ íƒ ë²„íŠ¼ ì„¸íŒ… (2~5, 6~10, 11~15, 16~20, 21~25)
  // í˜•ì‹: [ [min, max], label ]
  const playerRanges = [
    [[2,5], '2~5ëª…'],
    [[6,10], '6~10ëª…'],
    [[11,15], '11~15ëª…'],
    [[16,20], '16~20ëª…'],
    [[21,25], '21~25ëª…'],
  ];

  function createSelectButtons() {
    overlay.innerHTML = '';
    playerRanges.forEach((range) => {
      const [[min, max], label] = range;
      const btn = document.createElement('button');
      btn.className = 'btn-select';
      btn.textContent = max === 5 ? 'ì‹œì‘' : 'ë¦¬ê·¸ ì‹œì‘';
      btn.title = `${label} ì„ íƒ (${min}ëª…ë¶€í„° ìµœëŒ€ ${max}ëª…)`;
      btn.dataset.min = min;
      btn.dataset.max = max;
      btn.dataset.label = label;
      btn.addEventListener('click', () => onSelectPlayers(min, max));
      overlay.appendChild(btn);
    });
  }

  function onSelectPlayers(min, max) {
    // ì°¸ê°€ì ìˆ˜ë¥¼ ëœë¤ìœ¼ë¡œ ì •í•  ìˆ˜ë„ ìˆì§€ë§Œ, ì—¬ê¸°ì„  maxë¡œ ê³ ì •(ìµœëŒ€ ì¸ì›)
    // í•„ìš” ì‹œ ëœë¤ìœ¼ë¡œ min~max ë²”ìœ„ ë‚´ë¡œ ë½‘ë„ë¡ ë³€ê²½ ê°€ëŠ¥
    totalPlayers = max;
    remainingPlayers = Array.from({length: totalPlayers}, (_, i) => i + 1);
    finalists = [];
    round = 1;
    overlay.classList.add('hidden');
    updateMessage(`${round}ë¼ìš´ë“œ: ì†ê°€ë½ì„ ì˜¬ë ¤ì£¼ì„¸ìš” (ìµœëŒ€ ${maxGroup}ëª…)`);
    updateWinnersList();
  }

  // ë©”ì‹œì§€ ì¶œë ¥ í•¨ìˆ˜
  function updateMessage(text, show=true) {
    if (show) {
      messageEl.textContent = text;
      messageEl.style.display = 'block';
      messageEl.style.pointerEvents = 'auto';
    } else {
      messageEl.style.display = 'none';
      messageEl.textContent = '';
      messageEl.style.pointerEvents = 'none';
    }
  }

  // ë‹¹ì²¨ì ëˆ„ì  í‘œì‹œ ê°±ì‹ 
  function updateWinnersList() {
    winnersListEl.innerHTML = '';
    finalists.forEach((w, idx) => {
      const div = document.createElement('div');
      div.innerHTML = `<strong>${w.round}:</strong> <span style="color:${w.color}; font-weight:bold;">${w.number}ë²ˆ</span>`;
      winnersListEl.appendChild(div);
    });
  }

  // ì› ìƒì„± í•¨ìˆ˜
  function createCircle(id, x, y, number, color) {
    const circle = document.createElement('div');
    circle.classList.add('circle');
    circle.style.left = `${x - 50}px`;
    circle.style.top = `${y - 50}px`;
    circle.style.backgroundColor = color;
    circle.dataset.id = id;
    circle.textContent = number;
    document.body.appendChild(circle);
    return circle;
  }
  function removeCircle(id) {
    const el = document.querySelector(`.circle[data-id='${id}']`);
    if (el) el.remove();
  }
  function updateCirclePosition(id, x, y) {
    const el = document.querySelector(`.circle[data-id='${id}']`);
    if (el) {
      el.style.left = `${x - 50}px`;
      el.style.top = `${y - 50}px`;
    }
  }

  // ì§„ì… ëŒ€ê¸° ìƒíƒœì¸ì§€ ì²´í¬
  function checkIfIdle() {
    if (Object.keys(touches).length >= 2) {
      if (checkIdleTimeout) clearTimeout(checkIdleTimeout);
      checkIdleTimeout = setTimeout(() => {
        if (!gameStarted) {
          startGame();
        }
      }, 3000);
    }
  }

  // ê²Œì„ ì‹œì‘
  function startGame() {
    gameStarted = true;
    updateMessage(`ğŸ® ${round}ë¼ìš´ë“œ ì‹œì‘! ëœë¤ íƒˆë½ ì¤‘...`, true);
    navigator.vibrate && navigator.vibrate([300, 100, 300]);

    // í„°ì¹˜ ì¤‘ì¸ ì•„ì´ë”” ë°°ì—´ ë³µì‚¬
    const ids = Object.keys(touches);
    if (ids.length < 2) {
      // í”Œë ˆì´ì–´ ë¶€ì¡± ì‹œ ë°”ë¡œ ë‹¹ì²¨ ì²˜ë¦¬
      const winnerId = ids[0];
      if (winnerId) {
        announceWinner(winnerId);
      }
      return;
    }

    const interval = setInterval(() => {
      if (ids.length <= 1) {
        clearInterval(interval);
        if (ids[0]) {
          announceWinner(ids[0]);
        }
        return;
      }

      // ë¬´ì‘ìœ„ íƒˆë½ í•œëª… ì œê±°
      const randomIndex = Math.floor(Math.random() * ids.length);
      const removedId = ids.splice(randomIndex, 1)[0];
      removeCircle(removedId);
      delete touches[removedId];
    }, 1500);
  }

  // ë‹¹ì²¨ì ë°œí‘œ ë° ì²˜ë¦¬
  function announceWinner(id) {
    const winner = touches[id];
    if (!winner) return;

    updateMessage(`ğŸ¯ ${winner.number}ë²ˆ ìƒì¡´! í„°ì¹˜í•˜ë©´ ë‹¤ìŒ ì§„í–‰`, true);
    finalists.push({ number: winner.number, color: winner.color, round: `${round}ë¼ìš´ë“œ` });

    // ë‹¹ì²¨ì í‘œì‹œ ê°±ì‹ 
    updateWinnersList();

    // ë‹¤ìŒ ë¼ìš´ë“œ ì¤€ë¹„
    gameStarted = false;

    // í„°ì¹˜ ì´ë²¤íŠ¸ë¡œ ë‹¤ìŒ ë¼ìš´ë“œ ì§„í–‰ ëŒ€ê¸°
    function proceedNextRound() {
      messageEl.removeEventListener('click', proceedNextRound);
      messageEl.style.pointerEvents = 'none';

      // ì› ëª¨ë‘ ì œê±°, í„°ì¹˜ ì´ˆê¸°í™”
      Object.keys(touches).forEach(removeCircle);
      for (const k in touches) delete touches[k];
      currentTouchIds.clear();

      // ê²°ìŠ¹ì „ ì§„ì… ì¡°ê±´ íŒë‹¨
      if (round === 'ğŸ”¥ ê²°ìŠ¹ì „') {
        // ê²°ìŠ¹ ì¢…ë£Œ, ìµœì¢… ìš°ìŠ¹ì ë°œí‘œ ë° ë¦¬ì…‹ ëŒ€ê¸°
        updateMessage(`ğŸ† ìµœì¢… ìš°ìŠ¹ì: ${finalists[0].number}ë²ˆ! í„°ì¹˜í•˜ë©´ ë‹¤ì‹œ ì‹œì‘í•©ë‹ˆë‹¤`, true);
        messageEl.addEventListener('click', () => {
          resetGame();
        }, { once: true });
      } else {
        // ì¼ë°˜ ë¼ìš´ë“œ ì§„í–‰
        // ë‚¨ì€ ì„ ìˆ˜ ì¬ì„¤ì • (ë‚¨ì€ í”Œë ˆì´ì–´ ë¦¬ìŠ¤íŠ¸ ì¤„ì´ê¸°)
        remainingPlayers = remainingPlayers.filter(n => n !== winner.number);
        if (remainingPlayers.length === 0 && finalists.length > 1) {
          // ë‹¤ìŒ ë‹¨ê³„: ê²°ìŠ¹ì „
          remainingPlayers = finalists.map(f => f.number);
          finalists = [];
          round = 'ğŸ”¥ ê²°ìŠ¹ì „';
        } else if (remainingPlayers.length === 0) {
          // ìš°ìŠ¹ì í™•ì •
          round = 'ì™„ë£Œ';
          updateMessage(`ğŸ† ìµœì¢… ìš°ìŠ¹ì: ${winner.number}ë²ˆ! í„°ì¹˜í•˜ë©´ ë‹¤ì‹œ ì‹œì‘í•©ë‹ˆë‹¤`, true);
          messageEl.addEventListener('click', () => {
            resetGame();
          }, { once: true });
          return;
        } else {
          // ë‹¤ìŒ ë¼ìš´ë“œ ìˆ«ì ì¦ê°€
          round = typeof round === 'number' ? round + 1 : 1;
        }
        updateMessage(`${round}ë¼ìš´ë“œ: ì†ê°€ë½ì„ ì˜¬ë ¤ì£¼ì„¸ìš” (ìµœëŒ€ ${maxGroup}ëª…)`, true);
      }
    }
    messageEl.style.pointerEvents = 'auto';
    messageEl.addEventListener('click', proceedNextRound, { once: true });
  }

  // ê²Œì„ ì™„ì „ ì´ˆê¸°í™” ë° ì°¸ê°€ì ì„ íƒ í™”ë©´ ë³µê·€
  function resetGame() {
    updateMessage('');
    winnersListEl.innerHTML = '';
    remainingPlayers = [];
    finalists = [];
    round = 1;
    totalPlayers = 0;
    gameStarted = false;
    for (const k in touches) {
      removeCircle(k);
      delete touches[k];
    }
    currentTouchIds.clear();
    overlay.classList.remove('hidden');
  }

  // í„°ì¹˜ ì´ë²¤íŠ¸ ì²˜ë¦¬
  window.addEventListener('touchstart', (e) => {
    if (overlay.classList.contains('hidden') === false) {
      // ì„ íƒí™”ë©´ ì¼œì ¸ìˆìœ¼ë©´ í„°ì¹˜ ë¬´ì‹œ
      return;
    }
    if (gameStarted) return;
    updateMessage('', false);
    for (const t of e.changedTouches) {
      if (Object.keys(touches).length >= maxGroup) return;
      if (!touches[t.identifier]) {
        const number = remainingPlayers.shift();
        if (!number) return;
        const color = getRandomColor();
        const circle = createCircle(t.identifier, t.clientX, t.clientY, number, color);
        touches[t.identifier] = { el: circle, number, color };
        currentTouchIds.add(t.identifier);
      }
    }
    checkIfIdle();
  }, { passive: false });

  window.addEventListener('touchmove', (e) => {
    if (gameStarted) return;
    for (const t of e.changedTouches) {
      if (touches[t.identifier]) updateCirclePosition(t.identifier, t.clientX, t.clientY);
    }
  }, { passive: false });

  window.addEventListener('touchend', (e) => {
    if (gameStarted) return;
    for (const t of e.changedTouches) {
      if (touches[t.identifier]) {
        removeCircle(t.identifier);
        remainingPlayers.unshift(touches[t.identifier].number);
        delete touches[t.identifier];
        currentTouchIds.delete(t.identifier);
      }
    }
    if (round !== 'ì™„ë£Œ') {
      updateMessage(`${round}ë¼ìš´ë“œ: ì†ê°€ë½ì„ ì˜¬ë ¤ì£¼ì„¸ìš” (ìµœëŒ€ ${maxGroup}ëª…)`);
    }
  }, { passive: false });

  // ì¤‘ë³µ ì œê±° í•¨ìˆ˜
  function getRandomColor() {
    // ëˆˆ ì•„í”„ì§€ ì•Šì€ ì„ ì—ì„œ ì ë‹¹íˆ ë°ì€ ìƒ‰ ëœë¤ ìƒì„±
    const colors = [
      '#00ffff','#ff4500','#ffd700','#7fff00','#00ff7f',
      '#ff69b4','#1e90ff','#ffa500','#adff2f','#ff6347'
    ];
    return colors[Math.floor(Math.random() * colors.length)];
  }

  // ì´ˆê¸° ì…‹íŒ…
  createSelectButtons();
  updateMessage('ì°¸ê°€ ì¸ì›ì„ ì„ íƒí•˜ì„¸ìš”');
})();
</script>

</body>
</html>
