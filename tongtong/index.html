<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì„œë°”ì´ë²Œ ê²Œì„ - ì™„ì „ì²´</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      overflow: hidden;
      font-family: 'Pretendard', sans-serif;
      background: #fef9f3;
      -webkit-tap-highlight-color: transparent;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    canvas {
      display: block;
      background: #fff9e7;
    }

    #infoBar {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: linear-gradient(90deg, #f4c542, #d4af37);
      color: #3a2e00;
      font-weight: 700;
      font-size: 16px;
      padding: 12px 16px;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.12);
      z-index: 20;
      display: flex;
      justify-content: space-between;
      align-items: center;
      user-select: none;
    }

    #winnerOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.75);
      color: #fff;
      font-weight: 900;
      font-size: 36px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 50;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.6s ease;
      text-align: center;
      padding: 20px;
    }

    #winnerOverlay.show {
      opacity: 1;
      pointer-events: auto;
    }

    #winnerText {
      background: linear-gradient(45deg, #ffe259, #ffa751);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: popInScale 0.6s ease forwards;
      margin-bottom: 24px;
      user-select: none;
    }

    @keyframes popInScale {
      0% {
        opacity: 0;
        transform: scale(0.5);
      }

      100% {
        opacity: 1;
        transform: scale(1);
      }
    }

    #finalList {
      max-width: 480px;
      width: 90vw;
      max-height: 50vh;
      overflow-y: auto;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(255, 215, 0, 0.7);
      user-select: text;
      font-size: 18px;
      margin-bottom: 24px;
    }

    #finalList table {
      width: 100%;
      border-collapse: collapse;
    }

    #finalList th,
    #finalList td {
      border: 1px solid #d4af37;
      padding: 8px 12px;
      text-align: center;
    }

    #finalList th {
      background: #f4c542;
      color: #3a2e00;
      font-weight: 700;
    }

    #finalList td.colorCell {
      font-weight: 700;
      color: #fff;
      border-radius: 6px;
    }

    #finalList td.color-1 {
      background-color: #f94144;
    }

    #finalList td.color-2 {
      background-color: #f3722c;
    }

    #finalList td.color-3 {
      background-color: #f8961e;
    }

    #finalList td.color-4 {
      background-color: #f9c74f;
      color: #3a2e00;
    }

    #finalList td.color-5 {
      background-color: #90be6d;
    }

    #finalList td.color-6 {
      background-color: #43aa8b;
    }

    #finalList td.color-7 {
      background-color: #577590;
    }

    #finalList td.color-8 {
      background-color: #277da1;
    }

    #finalList td.color-9 {
      background-color: #4d908e;
    }

    #finalList td.color-10 {
      background-color: #f94144;
    }

    /* ë™ê·¸ë¼ë¯¸ í‘œì‹œ ìŠ¤íƒ€ì¼ */
    .playerCircle {
      position: absolute;
      border-radius: 50%;
      border: 3px solid #333;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: 700;
      color: #000;
      user-select: none;
      cursor: default;
      box-shadow: 0 0 6px rgba(0, 0, 0, 0.15);
    }

    /* í„°ì¹˜ ì‹œ ìˆ«ì ì› ë°–ì— í‘œì‹œ */
    .outsideNumber {
      position: absolute;
      font-weight: 800;
      background: #fff;
      border-radius: 8px;
      padding: 2px 6px;
      box-shadow: 0 0 4px rgba(0, 0, 0, 0.1);
      user-select: none;
      pointer-events: none;
      z-index: 10;
      font-size: 16px;
      color: #000;
      transform-origin: center center;
      transition: transform 0.25s ease, opacity 0.25s ease;
    }

    /* ë‹¹ì²¨ì ì• ë‹ˆë©”ì´ì…˜ */
    .winnerHighlight {
      animation: winnerGlow 1.4s ease infinite alternate;
    }

    @keyframes winnerGlow {
      0% {
        box-shadow: 0 0 8px 3px gold;
      }

      100% {
        box-shadow: 0 0 18px 8px orange;
      }
    }
  </style>
</head>

<body>
  <div id="infoBar">
    <div id="roundInfo">ë¼ìš´ë“œ: 0</div>
    <div id="winnerInfo">ë‹¹ì²¨ì: ì—†ìŒ</div>
  </div>

  <canvas id="gameCanvas"></canvas>

  <div id="winnerOverlay" role="alert" aria-live="assertive" tabindex="0" aria-label="ë‹¹ì²¨ì ì•Œë¦¼">
    <div id="winnerText"></div>
    <div id="finalList" style="display:none;"></div>
    <div style="font-size: 18px; user-select:none;">í„°ì¹˜í•˜ë©´ ê³„ì† ì§„í–‰ ë˜ëŠ” ë‹¤ì‹œ ì‹œì‘</div>
  </div>

  <audio id="popSound" src="https://cdn.pixabay.com/audio/2022/03/15/audio_0e9881b1ae.mp3" preload="auto"></audio>

  <script>
    (() => {
      const canvas = document.getElementById('gameCanvas');
      const ctx = canvas.getContext('2d');
      const infoBar = document.getElementById('infoBar');
      const roundInfo = document.getElementById('roundInfo');
      const winnerInfo = document.getElementById('winnerInfo');
      const winnerOverlay = document.getElementById('winnerOverlay');
      const winnerText = document.getElementById('winnerText');
      const finalList = document.getElementById('finalList');
      const popSound = document.getElementById('popSound');

      let players = [];
      let roundWinners = [];
      let currentRound = 0;
      const maxTouch = 5;
      let touched = [];
      const radius = 40;
      let gameActive = false;
      let winnerShowing = false;

      // í”Œë ˆì´ì–´ ìœ„ì¹˜ ì €ì¥í•´ì„œ ë§¤ë²ˆ ìœ„ì¹˜ ë°”ë€ŒëŠ”ê±° ë°©ì§€
      let playerPositions = [];

      // ìƒ‰ìƒ ë°°ì—´ (ì°¸ê°€ì ë²ˆí˜¸ë³„ ë°˜ë³µ ì ìš©)
      const colors = [
        '#f94144', '#f3722c', '#f8961e', '#f9c74f', '#90be6d',
        '#43aa8b', '#577590', '#277da1', '#4d908e', '#f94144'
      ];

      function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        drawPlayers();
      }

      window.addEventListener('resize', resize);

      function createPlayers(count) {
        players = [];
        roundWinners = [];
        currentRound = 0;
        gameActive = true;
        winnerShowing = false;
        touched = [];
        playerPositions = [];

        for (let i = 1; i <= count; i++) {
          players.push(i);
          // ëœë¤ ìœ„ì¹˜ ë°°ì • (ì¤‘ë³µ ìµœì†Œí™”)
          let pos = getNonOverlappingPosition(i);
          playerPositions.push(pos);
        }

        updateInfoBar();
        drawPlayers();
      }

      // ì¤‘ë³µ ìœ„ì¹˜ í”¼í•´ì„œ ëœë¤ ìœ„ì¹˜ ìƒì„±
      function getNonOverlappingPosition(playerNum) {
        const padding = radius + 10;
        let tries = 0;
        while (tries < 1000) {
          const x = Math.random() * (canvas.width - 2 * padding) + padding;
          const y = Math.random() * (canvas.height - 2 * padding) + padding + infoBar.offsetHeight;
          if (
            !playerPositions.some(pos => {
              const dx = pos.x - x;
              const dy = pos.y - y;
              const dist = Math.sqrt(dx * dx + dy * dy);
              return dist < radius * 2 + 10; // ìµœì†Œ ê±°ë¦¬ ìœ ì§€
            })
          ) {
            return { x, y };
          }
          tries++;
        }
        // ì‹¤íŒ¨ì‹œ ê·¸ëƒ¥ ëœë¤ ë¦¬í„´
        return { x: Math.random() * (canvas.width - 2 * padding) + padding, y: Math.random() * (canvas.height - 2 * padding) + padding + infoBar.offsetHeight };
      }

      function drawPlayers(highlightNum = null) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        players.forEach((num, idx) => {
          const pos = playerPositions[idx];
          ctx.beginPath();
          ctx.arc(pos.x, pos.y, radius, 0, Math.PI * 2);
          ctx.fillStyle = colors[(num - 1) % colors.length];
          ctx.fill();
          ctx.lineWidth = 3;
          ctx.strokeStyle = '#333';
          ctx.stroke();

          // ìˆ«ìëŠ” ì› ë°–ì— í‘œì‹œ
          ctx.font = 'bold 22px Pretendard, sans-serif';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';

          // ì› ë°–ì— ìˆ«ì í‘œì‹œ (ìœ„ìª½ì—)
          ctx.fillStyle = '#000';
          ctx.fillText(num, pos.x, pos.y - radius - 16);

          // í•˜ì´ë¼ì´íŠ¸ ì‹œ ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ ì› ê·¸ë¦¬ê¸°
          if (highlightNum === num) {
            ctx.lineWidth = 5;
            ctx.strokeStyle = '#ffeb3b';
            ctx.shadowColor = '#ffeb3b';
            ctx.shadowBlur = 16;
            ctx.beginPath();
            ctx.arc(pos.x, pos.y, radius + 6, 0, Math.PI * 2);
            ctx.stroke();
            ctx.shadowBlur = 0;
          }
        });
      }

      function updateInfoBar() {
        roundInfo.textContent = `ë¼ìš´ë“œ: ${currentRound}`;
        if (roundWinners.length === 0) {
          winnerInfo.textContent = 'ë‹¹ì²¨ì: ì—†ìŒ';
        } else {
          // ë‹¹ì²¨ì ë²ˆí˜¸ì— ë§ëŠ” ìƒ‰ ì…íˆê¸°
          winnerInfo.innerHTML = 'ë‹¹ì²¨ì: ' + roundWinners.map(num => `<span style="color:${colors[(num - 1) % colors.length]}; font-weight: 700;">${num}</span>`).join(', ');
        }
      }

      function handleTouch() {
        if (!gameActive || winnerShowing) return;
        if (touched.length >= maxTouch) return;

        // ì¤‘ë³µ ì•ˆ ë˜ê²Œ ëœë¤ ì„ íƒ
        let touchNum;
        do {
          touchNum = players[Math.floor(Math.random() * players.length)];
        } while (touched.includes(touchNum));

        touched.push(touchNum);
        drawPlayers();

        // í„°ì¹˜ì‹œ í„°ì¹˜í•œ ì› ìˆ«ì ìœ„ìª½ì— ë¿… ì• ë‹ˆë©”ì´ì…˜ ë„£ê¸°
        animateNumberPop(touchNum);

        if (touched.length === maxTouch) {
          setTimeout(() => {
            // ë¼ìš´ë“œ ë‹¹ì²¨ì ê²°ì •
            const winner = touched[Math.floor(Math.random() * touched.length)];
            roundWinners.push(winner);
            popSound.currentTime = 0;
            popSound.play();

            updateInfoBar();
            winnerShowing = true;
            showRoundWinner(winner);
          }, 1200);
        }
      }

      // ìˆ«ì íŒì—… ì• ë‹ˆë©”ì´ì…˜
      function animateNumberPop(num) {
        const idx = players.indexOf(num);
        if (idx === -1) return;
        const pos = playerPositions[idx];

        const animDiv = document.createElement('div');
        animDiv.textContent = num;
        animDiv.style.position = 'fixed';
        animDiv.style.left = `${pos.x}px`;
        animDiv.style.top = `${pos.y - radius - 20}px`;
        animDiv.style.transform = 'translate(-50%, 0)';
        animDiv.style.fontWeight = '900';
        animDiv.style.color = colors[(num - 1) % colors.length];
        animDiv.style.fontSize = '28px';
        animDiv.style.pointerEvents = 'none';
        animDiv.style.userSelect = 'none';
        animDiv.style.zIndex = '60';
        animDiv.style.opacity = '1';
        animDiv.style.transition = 'transform 0.6s ease, opacity 0.6s ease';
        document.body.appendChild(animDiv);

        requestAnimationFrame(() => {
          animDiv.style.transform = 'translate(-50%, -80px)';
          animDiv.style.opacity = '0';
        });

        setTimeout(() => {
          document.body.removeChild(animDiv);
        }, 700);
      }

      // ë¼ìš´ë“œ ë‹¹ì²¨ì ë³´ì—¬ì£¼ê¸° & í„°ì¹˜ë¡œ ë‹¤ìŒ ë¼ìš´ë“œ ì§„í–‰
      function showRoundWinner(num) {
        winnerText.innerHTML = `ë¼ìš´ë“œ ${currentRound} ë‹¹ì²¨ì: <span style="color:${colors[(num - 1) % colors.length]}">${num}</span>`;
        finalList.style.display = 'none';
        winnerOverlay.classList.add('show');
        winnerOverlay.focus();

        // í´ë¦­ ì´ë²¤íŠ¸ë¡œ ë‹¤ìŒ ë¼ìš´ë“œ ì§„í–‰ ë˜ëŠ” ê²Œì„ ì¢…ë£Œ ì²˜ë¦¬
        function onClick() {
          winnerOverlay.classList.remove('show');
          winnerShowing = false;
          touched = [];

          if (roundWinners.length === 1) {
            // 1ë¼ìš´ë“œë¶€í„° ì§„í–‰
            currentRound = 1;
            updateInfoBar();
            drawPlayers();
          }

          if (roundWinners.length < maxTouch) {
            currentRound++;
            updateInfoBar();
            drawPlayers();
          } else {
            // ë§ˆì§€ë§‰ ë¼ìš´ë“œ ëë‚¨ - ìµœì¢… ëª…ë‹¨ ë³´ì—¬ì£¼ê¸°
            showFinalList();
          }
          winnerOverlay.removeEventListener('click', onClick);
        }

        winnerOverlay.addEventListener('click', onClick);
      }

      // ìµœì¢… ëª…ë‹¨ í‘œ ë³´ì—¬ì£¼ê¸°
      function showFinalList() {
        winnerText.textContent = 'ìµœì¢… ìš°ìŠ¹ì ëª…ë‹¨';
        winnerOverlay.classList.add('show');
        finalList.style.display = 'block';

        // í‘œ ê·¸ë¦¬ê¸°
        finalList.innerHTML = `
          <table>
            <thead>
              <tr><th>ë¼ìš´ë“œ</th><th>ë‹¹ì²¨ì ë²ˆí˜¸</th></tr>
            </thead>
            <tbody>
              ${roundWinners.map((num, i) => `<tr>
                <td>${i + 1}</td>
                <td class="colorCell color-${(num % 10) || 10}">${num}</td>
              </tr>`).join('')}
            </tbody>
          </table>
        `;

        // ìµœì¢… ìš°ìŠ¹ì ê°•ì¡°
        winnerText.innerHTML = `ìµœì¢… ìš°ìŠ¹ì: <span style="color:${colors[(roundWinners[roundWinners.length - 1] - 1) % colors.length]}">${roundWinners[roundWinners.length - 1]}</span> ğŸ‰`;

        // í„°ì¹˜ ì‹œ ì´ˆê¸°í™”
        function onReset() {
          winnerOverlay.classList.remove('show');
          finalList.style.display = 'none';
          winnerShowing = false;
          currentRound = 0;
          roundWinners = [];
          createPlayers(players.length);
          winnerOverlay.removeEventListener('click', onReset);
        }
        winnerOverlay.addEventListener('click', onReset);
      }

      // ì´ˆê¸° ê²Œì„ ì‹œì‘
      createPlayers(15);

      // ìº”ë²„ìŠ¤ í„°ì¹˜ ì´ë²¤íŠ¸
      canvas.addEventListener('click', () => {
        handleTouch();
      });

      resize();
    })();
  </script>
</body>

</html>
